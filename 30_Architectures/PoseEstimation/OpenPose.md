---
tags:
  - MILAB
  - ComputerVision
  - Networks
  - PoseEstimation
---

# OpenPose: Realtime Multi-Person 2D Pose Estimation using Part Affinity Fields

## 1. 요약 (Abstract)

> **OpenPose**는 **Bottom-Up** 방식을 사용하여 이미지 내 다중 인원의 2D 자세를 실시간으로 추정하는 논문입니다. 핵심 아이디어는 신체 부위(part) 간의 **위치와 방향** 정보를 동시에 인코딩하는 **[[Part Affinity Fields|Part Affinity Fields(PAFs)]]** 를 제안하여, 사람 수에 관계없이 일정한 연산 속도를 유지하면서도 높은 정확도를 달성했습니다.

---

## 2. 배경: 기존 자세 추정 방식의 한계

### 2.1. Top-Down 방식의 문제
- **선 검출, 후 추정**: 먼저 이미지에서 사람을 검출(Person Detection)하고, 검출된 각 사람 영역(Bounding Box) 내에서 자세를 추정합니다.
- **단점**:
    - 사람들이 가깝게 붙어있거나 가려져서 초기 **사람 검출에 실패하면, 해당 사람의 자세 추정은 불가능**합니다.
    - 이미지에 포함된 **사람 수에 비례하여 연산 시간**이 증가하여 실시간 처리에 불리합니다.

### 2.2. Bottom-Up 방식의 한계
- **선 추정, 후 연결**: 이미지 내 모든 신체 부위(관절)를 먼저 검출하고, 이를 사람별로 올바르게 연결(grouping)하여 자세를 완성합니다.
- **단점**:
    - 초기 Bottom-up 방식들은 전역적인 맥락(global context)을 사용하지 못해, **신체 부위를 잘못 연결하는 경우**가 많았습니다.
    - 이를 해결하기 위해 비용이 큰 전역 추론(global inference)을 사용하면서, **실시간 처리의 이점을 잃었습니다.**

---

## 3. 핵심 아이디어: Part Affinity Fields (PAFs)
OpenPose는 기존 Bottom-up 방식의 한계를 극복하기 위해 **Part Affinity Fields(PAFs)** 를 제안합니다.

- **정의**: 각 신체 림브(limb, 예: 팔, 다리) 영역에 속한 픽셀들이 **어느 방향을 가리키는지**를 나타내는 2D 벡터장(Vector Field)입니다.
- **역할**: 신체 부위들의 **위치 정보(Confidence Map)와 방향 정보(PAF)를 모두 사용**하여, 어떤 부위들이 연결되어야 하는지에 대한 풍부한 단서를 제공합니다.
- **장점**:
    - **방향성(Orientation)** 과 **영역 지원(Region-support)** 정보를 모두 보존하여, 단순히 관절의 중간점(midpoint)만 사용하던 기존 방식의 한계를 극복했습니다.
    - 이를 통해 복잡한 상황에서도 신체 부위를 더 강건하게(robust) 연결할 수 있습니다.

---

## 4. 네트워크 아키텍처

### 4.1. 추론 파이프라인
- **이중 분기 다단계(Multi-Stage) 구조**: 네트워크는 두 개의 브랜치로 나뉘어, **Confidence Map**과 **PAF**를 순차적으로 반복하며 정제합니다.
    1.  **PAF 정제 ($T_P$ 단계)**: 먼저 이미지 특징맵(F)을 입력받아 $T_P$ 단계에 걸쳐 PAF($L$)를 반복적으로 정제합니다.
    2.  **Confidence Map 정제 ($T_C$ 단계)**: 잘 정제된 PAF를 기반으로 $T_C$ 단계에 걸쳐 신체 부위 Confidence Map($S$)을 예측하고 정제합니다.

$$
L_t=\phi_t(F,L_{t-1}),\ \ \forall2\le t\le T_P \quad (1)
$$

$$ E=\int_{u=0}^{1} L_c(p(u))\cdot \frac{d_{j_2}-d_{j_1}}{|d_{j_2}-d_{j_1}|_2}du,\ \ p(u)=(1-u)d_{j_1}+u d_{j_2} \quad (11),(12) $$

> - **(1)**: **PAF($L$) 예측 단계**입니다. 이전 스테이지($t-1$)의 예측 결과 $L_{t-1}$와 이미지 특징맵 $F$를 입력받아 현재 스테이지($t$)의 PAF 예측 $L_t$를 정제합니다.
> - **(2), (3)**: **Confidence Map($S$) 예측 단계**입니다. $T_P$번 정제된 최종 PAF $L^{T_P}$를 입력받아, $T_C$번의 스테이지에 걸쳐 Confidence Map $S_t$를 예측하고 정제합니다.

### 4.2. 손실 함수 (Loss Function)
- **중간 감독(Intermediate Supervision)**: 기울기 소실(gradient vanishing) 문제를 완화하기 위해, 각 스테이지가 끝날 때마다 손실(Loss)을 계산하여 전체 과정이 올바르게 학습되도록 합니다.

$$
f_{L}^{t_i}=\sum_{c=1}^{C}\sum_{p} W(p), |L_{c}^{t_i}(p)-L_c^{*}(p)\_2^2 \quad (4)
$$

$$ f_{S}^{t_k}=\sum_{j=1}^{J}\sum_{p} W(p),|S_{j}^{t_k}(p)-S_j^{*}(p)\|_2^2 \quad (5) $$

$$ f=\sum_{t=1}^{T_P} f_L^{t}+\sum_{t=T_P+1}^{T_P+T_C} f_S^{t} \quad (6) $$

> - **(4), (5)**: 각 스테이지($t$)의 예측 결과($L_c^t, S_j^t$)와 실제 정답($L_c^*, S_j^*$) 사이의 L2 오차를 계산합니다. $W(p)$는 라벨링이 없는 부분(예: 가려진 관절)의 오차는 계산하지 않도록 하는 마스크입니다.
> - **(6)**: **전체 손실 함수 $f$**는 모든 스테이지에서 계산된 PAF 손실($f_L^t$)과 Confidence Map 손실($f_S^t$)을 모두 더한 값입니다.

---

## 5. Ground Truth 생성

### 5.1. Confidence Map (신체 부위 검출용)
- 각 신체 부위의 정답 위치에 2D 가우시안 분포 형태의 히트맵(heatmap)을 생성합니다.

$$ S^{*}_{j,k}(p)=\exp\left(-\frac{\lVert p - x_{j,k}\rVert_2^{2}}{\sigma^{2}}\right)\tag{7}
$$ 

> - 특정 사람($k$)의 신체 부위($j$)가 $x_{j,k}$ 위치에 있을 때, 그 위치를 중심으로 가장 높은 신뢰도(peak)를 갖고 주변으로 갈수록 점차 감소하는 히트맵을 만듭니다.
> - 여러 사람의 관절이 겹칠 경우, `max` 연산을 통해 각 피크가 분리되도록 유지합니다.

### 5.2. Part Affinity Field (신체 부위 연결용)
- 각 림브(limb) 영역 내 픽셀에 대해, 한 관절에서 다음 관절로 향하는 단위 벡터(unit vector)를 정답으로 부여합니다.

$$ L^{*}_{c,k}(p)=
\begin{cases}
v & \text{if } p \text{ on limb }(c,k)\\
0 & \text{otherwise}
\end{cases} \quad (9), \quad
v=\frac{x_{j_{2},k}-x_{j_{1},k}}{\lVert x_{j_{2},k}-x_{j_{1},k}\rVert_2}
$$ 

> - 특정 사람($k$)의 림브($c$, 예: 어깨→팔꿈치)에 대해, 두 관절($j_1, j_2$)을 잇는 직선 위의 픽셀 $p$는 $j_1$에서 $j_2$로 향하는 **단위 벡터 $v$** 값을 갖습니다. 림브에 속하지 않는 다른 모든 픽셀은 0 값을 갖습니다.
> - 이를 통해 네트워크가 '어떤 픽셀이 어떤 림브에 속하는지'와 '그 림브의 방향이 어디인지'를 동시에 학습하게 합니다.

---

## 6. 다중 인원 자세 조립 (Multi-Person Parsing)
1.  **신체 부위 후보 검출**: Confidence Map에 NMS(Non-Maximum Suppression)를 적용하여 각 신체 부위의 후보 위치들을 찾습니다.
2.  **연결 후보 스코어링**: 두 부위 후보를 잇는 직선 경로를 따라 PAF 위에서 **선적분(line integral)**을 계산하여 연결 점수(score)를 매깁니다.

$$ E=\int_{u=0}^{1} L_c(p(u))\cdot \frac{d_{j_2}-d_{j_1}}{|d_{j_2}-d_{j_1}|_2}du,\ \ p(u)=(1-u)d_{j_1}+u d_{j_2} \quad (11),(12) $$

> - 이 **선적분 값 $E$**가 높을수록, 예측된 PAF 필드의 방향과 실제 두 부위의 연결 방향이 일치한다는 의미이므로, 올바른 '림브(limb)' 연결일 확률이 높다고 판단합니다.

3.  **최적 연결 탐색**: 계산된 점수를 기반으로 **헝가리안 알고리즘(Hungarian Algorithm)**을 사용한 이분 매칭(Bipartite Matching)을 통해 최적의 연결을 찾습니다.
4.  **탐욕적 조립(Greedy Assembly)**: 모든 관절을 동시에 매칭하는 것은 NP-Hard 문제이므로, 스패닝 트리(spanning tree) 구조를 활용하여 탐욕적으로 인접한 관절부터 조립해나가며 전체 사람의 자세를 완성합니다.

---

## 7. 성능 및 한계

### 7.1. 복잡도 및 실행 시간
- **CNN 추론**: 사람 수와 관계없이 $O(1)$의 복잡도를 가집니다.
- **파싱**: 이론적으로 $O(n^2)$이지만, 실제로는 사람 수 증가에 거의 영향을 받지 않는 **런타임 불변(invariant)** 특성을 보입니다.

### 7.2. 오류 분석 및 한계
- **주요 실패 원인**: 사람이 극심하게 밀집하거나 가려진 상황에서는 PAF 예측이 중첩되어 탐욕적 파싱 알고리즘이 실패하고 인물 병합 오류가 발생할 수 있습니다.
- **오탐**: 동물이나 조각상 등을 사람으로 잘못 탐지하는 경우가 있습니다.

---

## 8. 공헌 및 의의
- **PAF 제안**: 신체 부위의 위치와 방향을 동시에 인코딩하는 효율적인 표현 방식인 **PAF**를 제안했습니다.
- **실시간성 확보**: 사람 수에 무관한 효율적인 **Bottom-up** 아키텍처와 **탐욕적 파싱** 알고리즘을 통해 실시간 다중 인원 자세 추정을 가능하게 했습니다.
- **오픈소스 기여**: **OpenPose 라이브러리**를 공개하여 자세 추정 분야의 연구와 응용에 크게 기여했습니다.